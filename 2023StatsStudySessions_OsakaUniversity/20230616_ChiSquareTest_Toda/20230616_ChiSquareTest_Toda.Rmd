---
title: "χ2検定の基礎と実践 by 戸田梨鈴"
author: "まとめ by 金山篤志"
date: "2023-06-16"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
  pdf_document:
    toc: true
---

# 概要

χ2検定の基本理論と実際の適用方法について学びます。

- パラメトリックとノンパラメトリックの統計手法
- χ2検定の基礎とその実践
  - 練習問題：幼稚園のおもちゃの選択
    - 1変量のχ2検定（適合度の検定）
    - 2変量のχ2検定（独立性の検定）
    - マクネマー検定（対応のあるデータの分析）

# パラメトリックとノンパラメトリックの統計手法

統計分析には、「パラメトリック」な手法と「ノンパラメトリック」な手法という、二つの大きなカテゴリが存在します。「パラメトリック」な手法とは、データが特定の確率分布（例えば正規分布など）に従うという前提のもとで行われる分析方法を指します。対して、「ノンパラメトリック」な手法は、データが特定の分布に従うという強い前提を設けず、より一般的な状況に適用可能な手法を指します。

パラメトリックな手法は主に以下のようなデータに適用します：

- 比例尺度（0が基点で、間隔や比率が意味を持つ測定値）
- 間隔尺度（等間隔のスケールを持ち、間隔が意味を持つ測定値）

一方、ノンパラメトリックな手法は以下のようなデータに適用します：

- 名義尺度（単純にカテゴリを区別し、分類するための測定値）
- 順序尺度（順序や大小に意味があるが、間隔は一定ではない測定値）

詳しくは以下のリンクをご参照ください：

- [統計学の時間 - パラメトリックとノンパラメトリック](https://bellcurve.jp/statistics/course/1562.html)
- [Study Channel - パラメトリックとノンパラメトリック](https://www.study-channel.com/2015/06/parametric-nonparametric-test.html)

# χ2検定の基礎とその実践

χ2検定は、観測データが理論的な分布にどの程度適合しているかを調べる統計的手法です。それは各データの二乗の和が従う分布で、その形状は自由度によって変わります。

詳細については以下のリンクをご覧ください：

- [日経調査研究所 - χ2検定](https://service.nikkei-r.co.jp/glossary/chi-square-test/)
- [Best Biostatistics - 自由度の理解](https://best-biostatistics.com/contingency/degree-freedom.html)

## 練習問題：幼稚園のおもちゃの選択

ある幼稚園で、200名の子どもたち（男児100名、女児100名）が3種類のおもちゃ（A、B、C）から好きなものを選んだ結果を元に、子どもたちの選択と性別に関連性があるかどうかを、χ2検定を用いて検証してみましょう。

この練習問題では、"chap4practice.csv"という名前のデータセットを使います。以下に、解析を行う手順を説明します。

1. データの読み込み
2. データ型の確認
3. 表の作成
4. 検定手法の選択

これは基本的な練習問題であり、現実のデータ解析ではより複雑な手法（例えば、多重比較）が必要となることもあります。

それでは、まずはデータセットを読み込み、データの構造を確認しましょう。

```{r, error=TRUE, include=TRUE}
# CSVファイル 'chap4practice.csv' を読み込みます。chap4practice.csvというファイルがRの環境に読み込まれ、それをdatという変数に代入します。
dat <- read.csv("chap4practice.csv", header=T)
```

```{r, error=TRUE, include=TRUE}
# データの構造を確認します。datというデータフレームの情報（列名、データ型、最初の数行のデータなど）が表示されます。
str(dat)
```

```{r, error=TRUE, include=TRUE}
# 性別（dat$gender）とおもちゃの選択（dat$choice）との間のクロス集計表が作成されます。
table <- table(dat$gender, dat$choice)
```

```{r, error=TRUE, include=TRUE}
# 作成したクロス集計表を表示します。
table

```

```{r, error=TRUE, include=TRUE}
# chisq.test関数はχ2検定を実行する関数で、引数にクロス集計表を指定します。この検定により、性別とおもちゃの選択との間に統計的な関連性があるかどうかを判断します。
chisq.test(table)

```

## χ2適合度検定：1変量のχ2検定

1変量のχ2検定、またはχ2適合度検定は、観測データが特定の理論的分布にどの程度適合しているかを評価するための方法です。この方法は、観測された各カテゴリの頻度と、理論的な分布から予測される頻度とを比較し、二つの間に差異が存在するかどうかを調査します。

詳細については以下のリンクをご覧ください：

- [統計学の時間 - χ2適合度検定](https://bellcurve.jp/statistics/course/9494.html)

具体的な解析手順を見てみましょう。

```{r, error=TRUE, include=TRUE}
# 'chap4sample1.csv'というCSVファイルを読み込み、それをx1という変数に格納します。
x1 <- read.csv("chap4sample1.csv", header=T) 
head(x1)
```

```{r, error=TRUE, include=TRUE}
# x1というデータフレームの構造を確認します。どのような列があり、それぞれの列のデータ型は何か、データの先頭数行はどうなっているかなどが表示されます。
str(x1)
```

```{r, error=TRUE, include=TRUE}
# Answer列のデータを因子（カテゴリ変数）として扱うために変換します。factor関数は元のデータの値の小さい順（0から1へ）にレベルを割り当て、その後にlabelsで指定した名前が適用されます。つまり、元のデータの0は'No'に、1は'Yes'に対応づけられます。
x1$Answer <- factor(x1$Answer, labels=c('No','Yes')) 
head(x1)
```

```{r, error=TRUE, include=TRUE}
# Answer列のデータを元にクロス集計表を作成します。この表では、'No'と'Yes'の回答がそれぞれ何回あったかが表示されます。ここでは、'No'が15回、'Yes'が5回観測されたとしています。
x1table <- table(x1) 
x1table
```

```{r, error=TRUE, include=TRUE}
# chisq.test関数を用いて、χ2検定を実行します。この結果から、観測データが期待する分布にどの程度適合しているかを評価します。
chisq.test(x1table) 
```

```{r, error=TRUE, include=TRUE}
# 各カテゴリ（'No','Yes'）の数を直接指定して、χ2検定を実行します。ここでは、'No'が5回、'Yes'が15回観測されたとしています。
x1c <- c(5,15) 
x1c
```

```{r, error=TRUE, include=TRUE}
chisq.test(x1c) 
```

```{r, error=TRUE, include=TRUE}
# クロス集計表のデータを元に、円グラフを作成します。これにより、'No'と'Yes'の回答が全体に占める割合を視覚的に把握することができます。
pie(x1table) 
```

```{r, error=TRUE, include=TRUE}
# まずはクロス集計表（'No'と'Yes'の出現回数を数えたもの）のデータを用いて、円グラフを作成します。円グラフは、'No'と'Yes'が全体の中でどの程度の割合を占めているかを視覚的に表現するのに便利です。しかし、円グラフでは各カテゴリ間（ここでは'No'と'Yes'）の具体的な数値差を精確に把握することは難しいのが一般的です。
pie(x1table) 
```

```{r, error=TRUE, include=TRUE}
# 次に、同じクロス集計表のデータを使って、棒グラフを作成します。棒グラフは、各カテゴリ（ここでは'No'と'Yes'）の観測数を直感的に比較するのに適しています。そのため、'No'と'Yes'の出現回数の差を具体的に可視化したい場合には、棒グラフが有効です。この棒グラフでは、X軸に回答（'No'または'Yes'）、Y軸にその回答の数（観測数）を表示しています。なお、'barplot'関数はRの基本パッケージに含まれているため、追加のパッケージをインストールする必要はありません。
barplot(x1table, main="Number of 'No' and 'Yes'", xlab="Answer", ylab="Count", col=c("lightblue", "pink"))

```

## χ2独立性検定：2変量のχ2検定

2変量のχ2検定（独立性の検定）は、2つのカテゴリ変数間の関連性を評価します。具体的には、2つの変数が互いに独立であるという帰無仮説を立て、その帰無仮説が棄却できるかどうかを試します。

それでは、独立性の検定を行う具体的なコードを見てみましょう。


```{r, error=TRUE, include=TRUE}
# CSVファイル 'chap4sample2.csv' を読み込みます。
x2 <- read.csv("chap4sample2.csv", header=T) 
head(x2)
```

```{r, error=TRUE, include=TRUE}
# データの構造を確認します。
str(x2)
```

```{r, error=TRUE, include=TRUE}
# 性別と回答のクロス集計表を作成します。
x2table <- table(x2$gender, x2$answer)
x2table
```

```{r, error=TRUE, include=TRUE}
# クロス集計表に対してχ2検定を実行します。
chisq.test(x2table) 
```

```{r, error=TRUE, include=TRUE}
# クロス集計表を直接入力してχ2検定を実行します。
x2matrix <- matrix(c(14,6,5,15), ncol=2, byrow=T) 
rownames(x2matrix) <- c("F","M") 
colnames(x2matrix) <- c("Agree", "Disagree") 
x2matrix
chisq.test(x2matrix) 
```

```{r, error=TRUE, include=TRUE}
# フィッシャーの直接確率を計算します。
fisher.test(x2table) 
```

## マクネマー検定

マクネマー検定は、2つの対応のあるカテゴリデータの間の関連性を評価するためのχ2検定の一種です。具体的には、2つの状態（前後）を持つ被験者群について、その変化がランダムに起こっているかどうかを評価します。

それでは、マクネマー検定を行う具体的なコードを見てみましょう。

```{r, error=TRUE, include=TRUE}
# 'chap4sample3.csv'という名前のCSVファイルを読み込みます。
x3 <- read.csv("chap4sample3.csv", header=T)
```

```{r, error=TRUE, include=TRUE}
# データの構造を確認します。
str(x3)
```

```{r, error=TRUE, include=TRUE}
# データをクロス集計表形式に変換します。
x3table <- table(x3) 
```

```{r, error=TRUE, include=TRUE}
# クロス集計表に対してマクネマー検定を実行します。
mcnemar.test(x3table, correct=T) 
```

